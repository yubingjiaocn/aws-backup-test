# AWS Backup for EKS åŠŸèƒ½æµ‹è¯•æŒ‡å—

æœ¬æŒ‡å—ç”¨äºæµ‹è¯• AWS Backup å¯¹ EKS é›†ç¾¤çš„å¤‡ä»½å’Œæ¢å¤åŠŸèƒ½ã€‚

## ğŸ“‹ æµ‹è¯•ç›®æ ‡

éªŒè¯ AWS Backup åœ¨ä»¥ä¸‹ä¸¤ä¸ªåœºæ™¯ä¸­çš„èƒ½åŠ›:

1. **åœºæ™¯ä¸€: EKS ç‰ˆæœ¬å›æ»š** - å‡çº§å¤±è´¥åæ¢å¤åˆ°æ—§ç‰ˆæœ¬
2. **åœºæ™¯äºŒ: æ“ä½œé”™è¯¯æ¢å¤** - è¯¯åˆ é™¤èµ„æºåçš„æ•°æ®æ¢å¤

## â±ï¸ é¢„è®¡æ—¶é—´

- **å®Œæ•´æµ‹è¯•**: 2-4 å°æ—¶
- **æˆæœ¬**: çº¦ $1-2 ç¾å…ƒ (æµ‹è¯•åç«‹å³æ¸…ç†)

## ğŸ”§ å‰ç½®æ¡ä»¶

### 1. æ£€æŸ¥å·¥å…·

```bash
# æ£€æŸ¥å¿…éœ€å·¥å…·æ˜¯å¦å·²å®‰è£…
command -v aws && echo "âœ… AWS CLI"
command -v kubectl && echo "âœ… kubectl"
command -v eksctl && echo "âœ… eksctl"
command -v terraform && echo "âœ… Terraform"
command -v jq && echo "âœ… jq"
command -v helm && echo "âœ… Helm"
```

å¦‚æœç¼ºå°‘å·¥å…·,è¯·å…ˆå®‰è£…:
- AWS CLI: https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html
- kubectl: https://kubernetes.io/docs/tasks/tools/
- eksctl: https://eksctl.io/installation/
- Terraform: https://developer.hashicorp.com/terraform/install
- jq: `sudo apt install jq` æˆ– `brew install jq`
- Helm: https://helm.sh/docs/intro/install/

### 2. é…ç½® AWS å‡­è¯

```bash
# é…ç½® AWS å‡­è¯
aws configure

# éªŒè¯èº«ä»½
aws sts get-caller-identity
```

### 3. ç¡®è®¤ IAM æƒé™

æµ‹è¯•è´¦æˆ·éœ€è¦ä»¥ä¸‹æƒé™:
- EKS å®Œæ•´æƒé™
- EC2 å®Œæ•´æƒé™ (VPC, å­ç½‘, NAT ç½‘å…³ç­‰)
- IAM è§’è‰²åˆ›å»ºå’Œç®¡ç†
- AWS Backup å®Œæ•´æƒé™
- EFS å®Œæ•´æƒé™

## ğŸš€ æµ‹è¯•æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µ: ç¯å¢ƒå‡†å¤‡

```bash
# åˆ›å»ºé›†ç¾¤
./scripts/00-setup-environment.sh
```

### ç¬¬äºŒé˜¶æ®µ: åœºæ™¯ä¸€æµ‹è¯• - EKS ç‰ˆæœ¬å›æ»š

#### æ­¥éª¤ 4: åˆ›å»ºå¤‡ä»½

```bash
# åˆ›å»ºé›†ç¾¤å¤‡ä»½ (çº¦ 5-10 åˆ†é’Ÿ)
./scripts/01-create-backup.sh $CLUSTER_NAME

# ç­‰å¾…å¤‡ä»½å®Œæˆ,è®°å½• Recovery Point ARN
# è¾“å‡ºç¤ºä¾‹: arn:aws:backup:us-west-2:123456789012:recovery-point:xxxxx
```

**ä¿å­˜ Recovery Point ARN** - ä¸‹ä¸€æ­¥éœ€è¦ä½¿ç”¨!

#### æ­¥éª¤ 5: æ¨¡æ‹Ÿå‡çº§å¤±è´¥,æ¢å¤åˆ°æ–°é›†ç¾¤

```bash
# æ¢å¤åˆ°æ–°çš„ v1.32 é›†ç¾¤ (çº¦ 20-25 åˆ†é’Ÿ)
./scripts/02-restore-to-new-cluster.sh \
  --recovery-point-arn <ç²˜è´´ä¸Šä¸€æ­¥çš„ ARN> \
  --cluster-name eks-rollback-v132 \
  --eks-version 1.32

# ç­‰å¾…æ¢å¤å®Œæˆ...
```

#### æ­¥éª¤ 6: åœ¨æ–°é›†ç¾¤ä¸Šé…ç½® Add-on

```bash
# å¯ç”¨ CSI Drivers (ä½¿ç”¨ Pod Identity)
# æ³¨æ„: æ¢å¤çš„é›†ç¾¤ä¸ä¼šè‡ªåŠ¨åŒ…å«æ‰˜ç®¡ add-onsï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨
./scripts/03-enable-managed-addons.sh eks-rollback-v132

# é‡æ–°å®‰è£… Karpenter Controller (ä½¿ç”¨ CloudFormation åˆ›å»º IAM èµ„æº)
./scripts/04-install-karpenter.sh eks-rollback-v132
```

**è¯´æ˜**:
- æ–°åˆ›å»ºçš„é›†ç¾¤ä¼šé€šè¿‡ eksctl è‡ªåŠ¨å®‰è£… CSI drivers
- æ¢å¤çš„é›†ç¾¤éœ€è¦æ‰‹åŠ¨è¿è¡Œè„šæœ¬å¯ç”¨ add-ons

#### æ­¥éª¤ 7: éªŒè¯æ¢å¤ç»“æœ

```bash
# è¿è¡ŒéªŒè¯è„šæœ¬
./scripts/05-verify-restore.sh eks-rollback-v132
```

**éªŒè¯å†…å®¹**:
- âœ… é›†ç¾¤ç‰ˆæœ¬æ­£ç¡®
- âœ… æ‰€æœ‰èŠ‚ç‚¹å¥åº·
- âœ… å‘½åç©ºé—´å·²æ¢å¤
- âœ… Deployment å’Œ StatefulSet å·²æ¢å¤
- âœ… PVC å·²ç»‘å®š
- âœ… Karpenter CRD å’Œ CR å·²æ¢å¤
- âœ… æ•°æ®å®Œæ•´æ€§

### ç¬¬ä¸‰é˜¶æ®µ: åœºæ™¯äºŒæµ‹è¯• - æ“ä½œé”™è¯¯æ¢å¤

#### æ­¥éª¤ 8: æ¨¡æ‹Ÿæ“ä½œé”™è¯¯

```bash
# åˆ‡æ¢åˆ°åŸå§‹é›†ç¾¤
aws eks update-kubeconfig --name $CLUSTER_NAME --region us-west-2

# æ¨¡æ‹Ÿè¯¯åˆ é™¤
kubectl delete namespace test
kubectl delete -f test-workloads/karpenter-nodepool.yaml

# ç¡®è®¤èµ„æºå·²åˆ é™¤
kubectl get namespace test  # åº”è¯¥æ˜¾ç¤º NotFound
kubectl get nodepools -n karpenter  # åº”è¯¥ä¸ºç©º
```

#### æ­¥éª¤ 9: ä»å¤‡ä»½æ¢å¤

```bash
# ä½¿ç”¨ AWS Backup æ¢å¤åˆ°åŒä¸€é›†ç¾¤ (éç ´åæ€§)
# æ³¨æ„: è¿™æ˜¯å°±åœ°æ¢å¤,ä¸ä¼šè¦†ç›–ç°æœ‰å¯¹è±¡

aws backup start-restore-job \
  --recovery-point-arn <å¤‡ä»½çš„ Recovery Point ARN> \
  --metadata \
    clustername=$CLUSTER_NAME,\
    newCluster=false,\
    restoreOnlyClusterState=true \
  --iam-role-arn arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):role/AWSBackupDefaultServiceRole \
  --region us-west-2

# ç­‰å¾…æ¢å¤å®Œæˆ (çº¦ 5-10 åˆ†é’Ÿ)
# æŸ¥è¯¢æ¢å¤ä½œä¸šçŠ¶æ€
aws backup describe-restore-job \
  --restore-job-id <ä½œä¸š ID> \
  --region us-west-2
```

#### æ­¥éª¤ 10: éªŒè¯æ¢å¤

```bash
# æ£€æŸ¥å‘½åç©ºé—´æ˜¯å¦æ¢å¤
kubectl get namespace test

# æ£€æŸ¥ Pod æ˜¯å¦æ¢å¤
kubectl get pods -n test

# æ£€æŸ¥ Karpenter NodePool æ˜¯å¦æ¢å¤
kubectl get nodepools -n karpenter

# éªŒè¯æ•°æ®å®Œæ•´æ€§
./scripts/05-verify-restore.sh $CLUSTER_NAME
```

## ğŸ§¹ æ¸…ç†èµ„æº

**é‡è¦**: æµ‹è¯•å®Œæˆåç«‹å³æ¸…ç†,é¿å…äº§ç”Ÿä¸å¿…è¦çš„è´¹ç”¨!

### æ–¹æ³•ä¸€: ä½¿ç”¨è‡ªåŠ¨åŒ–æ¸…ç†è„šæœ¬ (æ¨è)

```bash
# æ¸…ç†æ‰€æœ‰æµ‹è¯•èµ„æºï¼ˆåŒ…æ‹¬åŸå§‹é›†ç¾¤å’Œæ¢å¤çš„é›†ç¾¤ï¼‰
cd /home/ubuntu/aws-backup-test

# è·å–é›†ç¾¤åç§°
CLUSTER_NAME=$(cd terraform && terraform output -raw cluster_name 2>/dev/null || echo "")

# è¿è¡Œæ¸…ç†è„šæœ¬
./scripts/99-cleanup-all.sh $CLUSTER_NAME eks-rollback-v132

# æˆ–è€…å…ˆé¢„è§ˆå°†è¦åˆ é™¤çš„èµ„æº
./scripts/99-cleanup-all.sh --dry-run $CLUSTER_NAME eks-rollback-v132
```

**æ¸…ç†è„šæœ¬ä¼šè‡ªåŠ¨åˆ é™¤**:
1. âœ… Karpenter åˆ›å»ºçš„ EC2 å®ä¾‹å’Œ Launch Templates
2. âœ… Karpenter CloudFormation Stacks å’Œ IAM èµ„æº
3. âœ… CSI Driver çš„ IAM è§’è‰²å’Œ Pod Identity Associations
4. âœ… EKS é›†ç¾¤å’Œæ‰€æœ‰ç›¸å…³èµ„æºï¼ˆAddons, Node Groups, OIDC Providerï¼‰
5. âœ… Terraform åˆ›å»ºçš„ VPCã€EFS ç­‰åŸºç¡€è®¾æ–½
6. â„¹ï¸ åˆ—å‡º AWS Backup å¤‡ä»½ç‚¹ï¼ˆéœ€è¦æ‰‹åŠ¨åˆ é™¤ï¼‰

### æ–¹æ³•äºŒ: æ‰‹åŠ¨æ¸…ç†

å¦‚æœéœ€è¦æ‰‹åŠ¨æ¸…ç†æˆ–æ¸…ç†è„šæœ¬å¤±è´¥ï¼š

```bash
# 1. åˆ é™¤ Karpenter èµ„æº
# Launch Templates
aws ec2 describe-launch-templates \
  --filters "Name=tag:karpenter.k8s.aws/cluster,Values=${CLUSTER_NAME}" \
  --region us-west-2 | \
  jq -r ".LaunchTemplates[].LaunchTemplateName" | \
  xargs -I{} aws ec2 delete-launch-template --launch-template-name {} --region us-west-2

# CloudFormation Stacks
aws cloudformation delete-stack --stack-name "Karpenter-${CLUSTER_NAME}" --region us-west-2
aws cloudformation delete-stack --stack-name "Karpenter-eks-rollback-v132" --region us-west-2

# 2. åˆ é™¤ CSI Driver IAM è§’è‰²ï¼ˆå¦‚æœæ‰‹åŠ¨åˆ›å»ºçš„ï¼‰
aws iam delete-role --role-name "AmazonEKS_EBS_CSI_DriverRole_${CLUSTER_NAME}"
aws iam delete-role --role-name "AmazonEKS_EFS_CSI_DriverRole_${CLUSTER_NAME}"

# 3. åˆ é™¤æ‰€æœ‰ EKS é›†ç¾¤
eksctl delete cluster --name $CLUSTER_NAME --region us-west-2 --wait
eksctl delete cluster --name eks-rollback-v132 --region us-west-2 --wait

# 4. é”€æ¯ Terraform èµ„æº
cd /home/ubuntu/aws-backup-test/terraform
terraform destroy -auto-approve

# 5. (å¯é€‰) åˆ é™¤ AWS Backup å¤‡ä»½ç‚¹
# è·å–å¤‡ä»½ä¿ç®¡åº“åç§°
BACKUP_VAULT=$(cd terraform && terraform output -raw backup_vault_name 2>/dev/null || echo "Default")

aws backup list-recovery-points-by-backup-vault \
  --backup-vault-name $BACKUP_VAULT \
  --region us-west-2

# æ‰‹åŠ¨åˆ é™¤å¤‡ä»½ç‚¹
aws backup delete-recovery-point \
  --backup-vault-name $BACKUP_VAULT \
  --recovery-point-arn <ARN> \
  --region us-west-2
```

## âœ… é¢„æœŸç»“æœ

### åœºæ™¯ä¸€: ç‰ˆæœ¬å›æ»š

| éªŒè¯é¡¹ | é¢„æœŸç»“æœ |
|--------|---------|
| é›†ç¾¤ç‰ˆæœ¬ | âœ… v1.32 |
| èŠ‚ç‚¹çŠ¶æ€ | âœ… Ready |
| å‘½åç©ºé—´ | âœ… å·²æ¢å¤ |
| Deployments | âœ… å·²æ¢å¤ |
| StatefulSets | âœ… å·²æ¢å¤ |
| PVC | âœ… Bound |
| EBS æ•°æ® | âœ… è‡ªåŠ¨é‡æ–°æŒ‚è½½ |
| Karpenter CRDs | âœ… å·²æ¢å¤ |
| Karpenter CRs | âœ… å·²æ¢å¤ |
| Karpenter Controller | âš ï¸ éœ€è¦æ‰‹åŠ¨é‡æ–°å®‰è£… |
| CSI Drivers | âš ï¸ éœ€è¦æ‰‹åŠ¨å¯ç”¨ |

### åœºæ™¯äºŒ: æ“ä½œé”™è¯¯æ¢å¤

| éªŒè¯é¡¹ | é¢„æœŸç»“æœ |
|--------|---------|
| è¯¯åˆ é™¤çš„å‘½åç©ºé—´ | âœ… å·²æ¢å¤ |
| è¯¯åˆ é™¤çš„ Pods | âœ… å·²æ¢å¤ |
| è¯¯åˆ é™¤çš„ CRs | âœ… å·²æ¢å¤ |
| æ•°æ®å®Œæ•´æ€§ | âœ… å®Œæ•´ |
| æ¢å¤æ–¹å¼ | âœ… éç ´åæ€§ |

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **ç‰ˆæœ¬å›æ»šé™åˆ¶**
   - âŒ æ— æ³•åœ¨åŒä¸€é›†ç¾¤ä¸Šé™çº§ Kubernetes ç‰ˆæœ¬
   - âœ… å¿…é¡»æ¢å¤åˆ°æ–°é›†ç¾¤æ‰èƒ½å®ç°ç‰ˆæœ¬å›æ»š

2. **æƒé™é…ç½®**
   - âœ… æ–°é›†ç¾¤ä½¿ç”¨ **Pod Identity** è¿›è¡Œæƒé™ç®¡ç†ï¼ˆ`addonsConfig.autoApplyPodIdentityAssociations: true`ï¼‰
   - âœ… CSI drivers åœ¨æ–°é›†ç¾¤åˆ›å»ºæ—¶è‡ªåŠ¨å®‰è£…ï¼ŒIAM æƒé™è‡ªåŠ¨é…ç½®
   - âš ï¸ æ¢å¤çš„é›†ç¾¤éœ€è¦æ‰‹åŠ¨å¯ç”¨æ‰˜ç®¡ add-ons

3. **éœ€è¦æ‰‹åŠ¨æ“ä½œ**
   - âš ï¸ æ¢å¤çš„é›†ç¾¤çš„æ‰˜ç®¡ Add-on (CSI Drivers) éœ€è¦æ‰‹åŠ¨å¯ç”¨
   - âš ï¸ Karpenter Controller éœ€è¦é‡æ–°å®‰è£… (CRDs/CRs ä¼šè‡ªåŠ¨æ¢å¤)
   - âš ï¸ EFS Access Points éœ€è¦æ‰‹åŠ¨åˆ›å»º

4. **æ¢å¤è¡Œä¸º**
   - â„¹ï¸ æ¢å¤æ˜¯éç ´åæ€§çš„,ä¸ä¼šè¦†ç›–é›†ç¾¤ä¸­å·²å­˜åœ¨çš„å¯¹è±¡
   - â„¹ï¸ å¦‚æœå¯¹è±¡å·²å­˜åœ¨,æ¢å¤æ“ä½œä¼šè·³è¿‡è¯¥å¯¹è±¡

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: PVC ä¸€ç›´ Pending

**åŸå› **: CSI Driver æœªå¯ç”¨

**è§£å†³**:
```bash
./scripts/03-enable-managed-addons.sh <é›†ç¾¤åç§°>
kubectl get pods -n kube-system | grep csi
```

### é—®é¢˜ 2: Karpenter æ— æ³•åˆ›å»ºèŠ‚ç‚¹

**åŸå› **: Karpenter Controller æœªå®‰è£…æˆ– IAM è§’è‰²é…ç½®é”™è¯¯

**è§£å†³**:
```bash
# æ£€æŸ¥ Karpenter Pod
kubectl get pods -n karpenter

# æ£€æŸ¥æ—¥å¿—
kubectl logs -n karpenter -l app.kubernetes.io/name=karpenter

# æ£€æŸ¥ CloudFormation Stack
aws cloudformation describe-stacks --stack-name Karpenter-<é›†ç¾¤åç§°>

# é‡æ–°å®‰è£… (ä¼šä½¿ç”¨ CloudFormation åˆ›å»º IAM èµ„æº)
./scripts/04-install-karpenter.sh <é›†ç¾¤åç§°>
```

### é—®é¢˜ 3: IAM è§’è‰²ä¸å­˜åœ¨

**åŸå› **: Terraform æœªæ­£ç¡®åˆ›å»º IAM è§’è‰²

**è§£å†³**:
```bash
cd terraform
terraform output cluster_role_arn
terraform output node_role_arn

# å¦‚æœè¾“å‡ºä¸ºç©º,é‡æ–° apply
terraform apply -auto-approve
```

### é—®é¢˜ 4: eksctl æ‰¾ä¸åˆ°å­ç½‘

**åŸå› **: eksctl é…ç½®æœªæ­£ç¡®ç”Ÿæˆ

**è§£å†³**:
```bash
./eksctl-config/export-tf-outputs.sh 1.32
cat eksctl-config/cluster-generated.yaml
```

### é—®é¢˜ 5: å¤‡ä»½ä½œä¸šå¤±è´¥

**æ£€æŸ¥**:
```bash
# æŸ¥çœ‹å¤‡ä»½ä½œä¸šè¯¦æƒ…
aws backup describe-backup-job \
  --backup-job-id <ä½œä¸š ID> \
  --region us-west-2

# æŸ¥çœ‹é”™è¯¯æ¶ˆæ¯
BACKUP_VAULT=$(cd terraform && terraform output -raw backup_vault_name 2>/dev/null || echo "Default")
aws backup list-backup-jobs \
  --by-backup-vault-name $BACKUP_VAULT \
  --region us-west-2 \
  --query 'BackupJobs[?State==`FAILED`]'
```

## ğŸ“Š æµ‹è¯•è®°å½•æ¨¡æ¿

```markdown
## æµ‹è¯•è®°å½•

**æµ‹è¯•æ—¥æœŸ**: YYYY-MM-DD
**æµ‹è¯•äººå‘˜**: å§“å
**AWS è´¦æˆ·**: 123456789012
**AWS åŒºåŸŸ**: us-west-2

### ç¯å¢ƒä¿¡æ¯
- Terraform ç‰ˆæœ¬:
- eksctl ç‰ˆæœ¬:
- kubectl ç‰ˆæœ¬:
- æºé›†ç¾¤ç‰ˆæœ¬: v1.32
- ç›®æ ‡é›†ç¾¤ç‰ˆæœ¬: v1.32

### åœºæ™¯ä¸€: ç‰ˆæœ¬å›æ»š
- [ ] åŸºç¡€è®¾æ–½åˆ›å»ºæˆåŠŸ
- [ ] EKS é›†ç¾¤åˆ›å»ºæˆåŠŸ
- [ ] æµ‹è¯•å·¥ä½œè´Ÿè½½éƒ¨ç½²æˆåŠŸ
- [ ] å¤‡ä»½åˆ›å»ºæˆåŠŸ
- [ ] Recovery Point ARN: _______________
- [ ] æ¢å¤åˆ°æ–°é›†ç¾¤æˆåŠŸ
- [ ] Add-on é…ç½®æˆåŠŸ
- [ ] Karpenter å®‰è£…æˆåŠŸ
- [ ] éªŒè¯è„šæœ¬é€šè¿‡

**é—®é¢˜è®°å½•**:


### åœºæ™¯äºŒ: æ“ä½œé”™è¯¯æ¢å¤
- [ ] æ¨¡æ‹Ÿåˆ é™¤æ“ä½œæˆåŠŸ
- [ ] æ¢å¤ä½œä¸šå¯åŠ¨æˆåŠŸ
- [ ] æ¢å¤ä½œä¸šå®Œæˆ
- [ ] å‘½åç©ºé—´æ¢å¤
- [ ] Pod æ¢å¤
- [ ] Karpenter CR æ¢å¤
- [ ] æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡

**é—®é¢˜è®°å½•**:


### æˆæœ¬ç»Ÿè®¡
- åŸºç¡€è®¾æ–½æˆæœ¬: $___
- EKS é›†ç¾¤æˆæœ¬: $___
- æ€»æµ‹è¯•æˆæœ¬: $___

### æ€»ç»“


```

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœæµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜:

1. æŸ¥çœ‹è„šæœ¬è¾“å‡ºçš„è¯¦ç»†æ—¥å¿—
2. æ£€æŸ¥ kubectl å’Œ AWS CLI å‘½ä»¤è¾“å‡º
3. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„"æ•…éšœæ’æŸ¥"éƒ¨åˆ†
4. ä¿å­˜é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—ä»¥ä¾¿åˆ†æ

## ğŸ¯ æµ‹è¯•å®Œæˆæ ‡å‡†

- âœ… åœºæ™¯ä¸€: æˆåŠŸåˆ›å»ºå¤‡ä»½å¹¶æ¢å¤åˆ°æ–°é›†ç¾¤,æ‰€æœ‰èµ„æºæ­£å¸¸è¿è¡Œ
- âœ… åœºæ™¯äºŒ: æˆåŠŸä»è¯¯åˆ é™¤ä¸­æ¢å¤èµ„æº,æ•°æ®å®Œæ•´
- âœ… éªŒè¯è„šæœ¬å…¨éƒ¨é€šè¿‡
- âœ… èµ„æºå·²æ¸…ç†,æ— é—ç•™è´¹ç”¨

ç¥æµ‹è¯•é¡ºåˆ©! ğŸš€
